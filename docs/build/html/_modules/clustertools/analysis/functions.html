
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>clustertools.analysis.functions &#8212; clustertools 0.1.dev1 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">clustertools 0.1.dev1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for clustertools.analysis.functions</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Functions to calculate StarCluster properties</span>

<span class="sd">Designed to accept StarCluster instance as in put to</span>
<span class="sd">calculate key parameters</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Jeremy J Webb&quot;</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s2">&quot;relaxation_time&quot;</span><span class="p">,</span>
  <span class="s2">&quot;half_mass_relaxation_time&quot;</span><span class="p">,</span>
  <span class="s2">&quot;core_relaxation_time&quot;</span><span class="p">,</span>
  <span class="s2">&quot;energies&quot;</span><span class="p">,</span>
  <span class="s2">&quot;closest_star&quot;</span><span class="p">,</span>
  <span class="s2">&quot;virialize&quot;</span><span class="p">,</span>
  <span class="s2">&quot;virial_radius&quot;</span><span class="p">,</span>
  <span class="s2">&quot;virial_radius_inverse_distance&quot;</span><span class="p">,</span>
  <span class="s2">&quot;virial_radius_critical_density&quot;</span><span class="p">,</span>
  <span class="s2">&quot;mass_function&quot;</span><span class="p">,</span>
  <span class="s2">&quot;eta_function&quot;</span><span class="p">,</span>
  <span class="s2">&quot;surface_area&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numba</span>
<span class="kn">from</span> <span class="nn">galpy.util</span> <span class="kn">import</span> <span class="n">bovy_coords</span>

<span class="kn">from</span> <span class="nn">..util.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..util.recipes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.operations</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..util.plots</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="relaxation_time"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.relaxation_time">[docs]</a><span class="k">def</span> <span class="nf">relaxation_time</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">rad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multimass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;spitzer&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       relaxation_time</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Calculate the relaxation time (Spitzer &amp; Hart 1971) within a given radius of the cluster</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster - StarCluster instance</span>

<span class="sd">       rad - radius within which to calculate the relaxation time</span>

<span class="sd">       multimass - use multimass (True) or single mass (False) value for ln lambda (default: True)</span>

<span class="sd">       projected - use projected values (default: False)</span>

<span class="sd">       method - choose between Spitzer &amp; Hart 1971 and other methods to be added later</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">       trelax</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2020 - Written - Webb (UofT)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">rad</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">projected</span><span class="p">:</span>
        <span class="n">rad</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">rmpro</span>
    <span class="k">elif</span> <span class="n">rad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rad</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">rm</span>

    <span class="n">grav</span><span class="o">=</span><span class="mf">4.302e-3</span>

    <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
        <span class="n">rindx</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">rpro</span> <span class="o">&lt;</span> <span class="n">rad</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rindx</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">rad</span>
        
    <span class="n">ntot</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rindx</span><span class="p">)</span>
    <span class="n">mbar</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">rindx</span><span class="p">])</span>
    <span class="n">vol</span><span class="o">=</span><span class="mf">4.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">rad</span><span class="o">**</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span>
    <span class="n">rho</span><span class="o">=</span><span class="n">ntot</span><span class="o">/</span><span class="n">vol</span>
    
    <span class="n">v2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">v</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    
    <span class="c1">#v2=0.4*grav*cluster.mtot/rad</span>
    
    <span class="n">lnlambda</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.4</span><span class="o">*</span><span class="n">cluster</span><span class="o">.</span><span class="n">ntot</span><span class="p">)</span>
    
    <span class="n">trelax</span><span class="o">=</span><span class="n">v2</span><span class="o">**</span><span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">15.4</span><span class="o">*</span><span class="n">grav</span><span class="o">**</span><span class="mf">2.</span><span class="o">*</span><span class="n">mbar</span><span class="o">**</span><span class="mf">2.</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">lnlambda</span><span class="p">)</span>

    <span class="c1"># Units of Myr</span>
    <span class="n">trelax</span><span class="o">*=</span> <span class="mf">3.086e13</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3600.0</span> <span class="o">*</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="mf">365.0</span> <span class="o">*</span> <span class="mf">1000000.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trelax</span></div>

<div class="viewcode-block" id="half_mass_relaxation_time"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.half_mass_relaxation_time">[docs]</a><span class="k">def</span> <span class="nf">half_mass_relaxation_time</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">multimass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       relaxation_time</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Calculate the half-mass relaxation time (Spitzer 1987) of the cluster</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster - StarCluster instance</span>

<span class="sd">       multimass - use multimass (True) or single mass (False) value for ln lambda (default: True)</span>

<span class="sd">       projected - use projected values (default: False)</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">       trelax</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2019 - Written - Webb (UofT)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grav</span><span class="o">=</span><span class="mf">4.302e-3</span>
    <span class="n">mass</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">mtot</span>
    <span class="n">ntot</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">ntot</span><span class="p">)</span>
    <span class="n">mbar</span><span class="o">=</span><span class="n">mass</span><span class="o">/</span><span class="n">ntot</span>
    <span class="n">lnlambda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.4</span><span class="o">*</span><span class="n">ntot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
        <span class="n">rm</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">rmpro</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rm</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">rm</span>


    <span class="n">trelax</span><span class="o">=</span><span class="mf">0.138</span><span class="o">*</span><span class="p">(</span><span class="n">mass</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">rm</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mbar</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">grav</span><span class="p">)</span><span class="o">*</span><span class="n">lnlambda</span><span class="p">)</span>
    <span class="c1"># Units of Myr</span>
    <span class="n">trelax</span><span class="o">*=</span> <span class="mf">3.086e13</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3600.0</span> <span class="o">*</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="mf">365.0</span> <span class="o">*</span> <span class="mf">1000000.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trelax</span></div>


<div class="viewcode-block" id="core_relaxation_time"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.core_relaxation_time">[docs]</a><span class="k">def</span> <span class="nf">core_relaxation_time</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">multimass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       core_relaxation_time</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Calculate the core relaxation time (Stone &amp; Ostriker 2015) of the cluster</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster - StarCluster instance</span>

<span class="sd">       multimass - use multimass (True) or single mass (False) value for ln lambda (default: True)</span>

<span class="sd">       projected - use projected values (default: False)</span>

<span class="sd">       method - choose between Spitzer 1987 and other methods to be added later</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">       trelax</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2019 - Written - Webb (UofT)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lnlambda</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.4</span><span class="o">*</span><span class="n">cluster</span><span class="o">.</span><span class="n">ntot</span><span class="p">)</span>
    <span class="n">mtot</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">mtot</span>
    <span class="n">mbar</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="n">rc</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">r10</span>
    <span class="n">rh</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">rm</span>
    <span class="n">grav</span><span class="o">=</span><span class="mf">4.302e-3</span>

    <span class="n">trelax</span><span class="o">=</span><span class="p">(</span><span class="mf">0.39</span><span class="o">/</span><span class="n">lnlambda</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rc</span><span class="o">**</span><span class="mf">3.</span><span class="o">/</span><span class="p">(</span><span class="n">grav</span><span class="o">*</span><span class="n">mtot</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">mtot</span><span class="o">/</span><span class="n">mbar</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rc</span><span class="o">*</span><span class="n">rh</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rc</span><span class="o">+</span><span class="n">rh</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trelax</span></div>


<div class="viewcode-block" id="energies"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.energies">[docs]</a><span class="k">def</span> <span class="nf">energies</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">specific</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">i_d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       energies</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Calculate kinetic and potential energy of every star</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster - StarCluster instance</span>

<span class="sd">       specific - find specific energies (default: True)</span>

<span class="sd">       i_d - find energies for a specific star</span>

<span class="sd">       full - calculate distance of full array of stars at once with numbra (default: True)</span>

<span class="sd">       parallel - calculate distances in parallel if True (default: False)</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">       ek,pot,etot</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2019 - Written - Webb (UofT)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">units0</span><span class="p">,</span> <span class="n">origin0</span> <span class="o">=</span> <span class="n">save_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">to_centre</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;nbody&quot;</span><span class="p">:</span>
        <span class="n">grav</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">cluster</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;pckms&quot;</span><span class="p">:</span>
        <span class="c1"># G has units of pc (km/s)^2 / Msun</span>
        <span class="n">grav</span> <span class="o">=</span> <span class="mf">4.302e-3</span>
    <span class="k">elif</span> <span class="n">cluster</span><span class="o">.</span><span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;kpckms&quot;</span><span class="p">:</span>
        <span class="c1"># G has units of kpc (km/s)^2 / Msun</span>
        <span class="n">grav</span> <span class="o">=</span> <span class="mf">4.302e-6</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grav</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">if</span> <span class="n">specific</span><span class="p">:</span>
        <span class="n">ek</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">v</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ek</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">v</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i_d</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">i_d</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">-</span> <span class="n">cluster</span><span class="o">.</span><span class="n">x</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">-</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">-</span> <span class="n">cluster</span><span class="o">.</span><span class="n">z</span>

        <span class="k">if</span> <span class="n">specific</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">cluter</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">*</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span>

        <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">dz</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">rindx</span> <span class="o">=</span> <span class="n">dr</span> <span class="o">!=</span> <span class="mf">0.0</span>
        <span class="n">gmr</span> <span class="o">=</span> <span class="o">-</span><span class="n">grav</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="n">rindx</span><span class="p">]</span> <span class="o">/</span> <span class="n">dr</span><span class="p">[</span><span class="n">rindx</span><span class="p">]</span>

        <span class="n">pot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gmr</span><span class="p">)</span>
        <span class="n">ek</span> <span class="o">=</span> <span class="n">ek</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
        <span class="n">etot</span> <span class="o">=</span> <span class="n">ek</span> <span class="o">+</span> <span class="n">pot</span>

    <span class="k">elif</span> <span class="n">full</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cluster</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
            <span class="n">pot</span> <span class="o">=</span> <span class="n">grav</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">potential_energy_parallel</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pot</span> <span class="o">=</span> <span class="n">grav</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">potential_energy</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">specific</span><span class="p">:</span>
            <span class="n">pot</span> <span class="o">/=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span>

        <span class="n">etot</span> <span class="o">=</span> <span class="n">ek</span> <span class="o">+</span> <span class="n">pot</span>
        <span class="n">cluster</span><span class="o">.</span><span class="n">add_energies</span><span class="p">(</span><span class="n">ek</span><span class="p">,</span> <span class="n">pot</span><span class="p">,</span> <span class="n">etot</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pot</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">ntot</span><span class="p">):</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cluster</span><span class="o">.</span><span class="n">x</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cluster</span><span class="o">.</span><span class="n">z</span>
            <span class="k">if</span> <span class="n">specific</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">cluter</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span>

            <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">dz</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">dr</span> <span class="o">!=</span> <span class="mf">0.0</span>
            <span class="n">gmr</span> <span class="o">=</span> <span class="o">-</span><span class="n">grav</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="n">dr</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>

            <span class="n">pot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gmr</span><span class="p">))</span>

        <span class="n">etot</span> <span class="o">=</span> <span class="n">ek</span> <span class="o">+</span> <span class="n">pot</span>
        <span class="n">cluster</span><span class="o">.</span><span class="n">add_energies</span><span class="p">(</span><span class="n">ek</span><span class="p">,</span> <span class="n">pot</span><span class="p">,</span> <span class="n">etot</span><span class="p">)</span>

    <span class="n">return_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">units0</span><span class="p">,</span> <span class="n">origin0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ek</span><span class="p">,</span> <span class="n">pot</span><span class="p">,</span> <span class="n">etot</span></div>


<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">potential_energy</span><span class="p">(</span><span class="n">cluster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       potential_energy</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Find potential energy for each star in a cluster</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster=[x,y,z,m].T</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">        energy</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2019 - Written - Webb (UofT)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cluster</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">cluster</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="n">energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">m2</span> <span class="o">/</span> <span class="n">r</span>
            <span class="n">energy</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">m2</span> <span class="o">/</span> <span class="n">r</span>

    <span class="k">return</span> <span class="n">energy</span>


<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">potential_energy_parallel</span><span class="p">(</span><span class="n">cluster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       potential_energy</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Find potential energy for each star in a cluster (done in parallel)</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster=[x,y,z,m].T</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">        energy</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2019 - Written - Webb (UofT)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">energy</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cluster</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">cluster</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="n">energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">m2</span> <span class="o">/</span> <span class="n">r</span>
            <span class="n">energy</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">m2</span> <span class="o">/</span> <span class="n">r</span>

    <span class="k">return</span> <span class="n">energy</span>


<div class="viewcode-block" id="closest_star"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.closest_star">[docs]</a><span class="k">def</span> <span class="nf">closest_star</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">ntot</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cluster</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cluster</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">minimum_distance</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="virialize"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.virialize">[docs]</a><span class="k">def</span> <span class="nf">virialize</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">specific</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       virialize</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Adjust stellar velocities so cluster is in virial equilibrium</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster - StarCluster instance</span>
<span class="sd">       specific - find specific energies (default: True)</span>
<span class="sd">       full - do full array of stars at once with numbra (default: True)</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">       qv</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2019 - Written - Webb (UofT)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">units0</span><span class="p">,</span> <span class="n">origin0</span> <span class="o">=</span> <span class="n">save_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">to_centre</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">qv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">cluster</span><span class="o">.</span><span class="n">qvir</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NEED TO CALCULATE ENERGIES FIRST&quot;</span><span class="p">)</span>
        <span class="n">energies</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">specific</span><span class="o">=</span><span class="n">specific</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">)</span>
        <span class="n">qv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">cluster</span><span class="o">.</span><span class="n">qvir</span><span class="p">))</span>

    <span class="n">cluster</span><span class="o">.</span><span class="n">vx</span> <span class="o">*=</span> <span class="n">qv</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">vy</span> <span class="o">*=</span> <span class="n">qv</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">vz</span> <span class="o">*=</span> <span class="n">qv</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">key_params</span><span class="p">()</span>

    <span class="n">energies</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">specific</span><span class="o">=</span><span class="n">specific</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">)</span>
    <span class="n">qv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">cluster</span><span class="o">.</span><span class="n">qvir</span><span class="p">))</span>

    <span class="n">return_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">units0</span><span class="p">,</span> <span class="n">origin0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">qv</span></div>


<span class="k">def</span> <span class="nf">rlagrange</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">nlagrange</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       rlagrange</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Calculate lagrange radii of the cluster by mass</span>
<span class="sd">       --&gt; Note units of lagrange radii will be equal to cluster.units</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster - StarCluster instance</span>
<span class="sd">       nlagrange - number of lagrange radii bins (default: 10)</span>
<span class="sd">       projected - calculate projected lagrange radii (default: False)</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">       rn</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2019 - Written - Webb (UofT)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">units0</span><span class="p">,</span> <span class="n">origin0</span> <span class="o">=</span> <span class="n">save_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">to_centre</span><span class="p">()</span>

    <span class="c1"># Radially order the stars</span>
    <span class="n">msum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">nfrac</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">rn</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">rproorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rorder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">rpro</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rorder</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">rproorder</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">rorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rorder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rorder</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">rorder</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">ntot</span><span class="p">):</span>
        <span class="n">mfrac</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">mtot</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">nfrac</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nlagrange</span><span class="p">)</span>
        <span class="n">msum</span> <span class="o">+=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">rorder</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">msum</span> <span class="o">&gt;=</span> <span class="n">mfrac</span><span class="p">:</span>
            <span class="n">rn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">rorder</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">nfrac</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">rn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nlagrange</span><span class="p">:</span>
        <span class="n">rn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">r</span><span class="p">))</span>

    <span class="n">return_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">units0</span><span class="p">,</span> <span class="n">origin0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rn</span>

<div class="viewcode-block" id="virial_radius"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.virial_radius">[docs]</a><span class="k">def</span> <span class="nf">virial_radius</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;inverse_distance&#39;</span><span class="p">,</span>
    <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">H</span><span class="o">=</span><span class="mf">70.0</span><span class="p">,</span>
    <span class="n">Om</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">overdens</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span>
    <span class="n">nrad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;inverse_distance&#39;</span><span class="p">:</span>
        <span class="n">rv</span><span class="o">=</span><span class="n">virial_radius_inverse_distance</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="n">projected</span><span class="o">=</span><span class="n">projected</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rv</span><span class="o">=</span><span class="n">virial_radius_critical_density</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">Om</span><span class="p">,</span><span class="n">overdens</span><span class="p">,</span><span class="n">nrad</span><span class="p">,</span><span class="n">projected</span><span class="p">,</span><span class="n">plot</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rv</span></div>

<div class="viewcode-block" id="virial_radius_inverse_distance"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.virial_radius_inverse_distance">[docs]</a><span class="k">def</span> <span class="nf">virial_radius_inverse_distance</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       virial_radius</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Calculate virial radius of the cluster as the inverse of the </span>
<span class="sd">                 average inverse distance between particles, weighted by their masses</span>
<span class="sd">       --&gt; Definition taken from AMUSE (www.amusecode.org)</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster - StarCluster instance</span>

<span class="sd">       projected - calculate projected virial radius (default: False)</span>

<span class="sd">       full - Use Numba (default:True)</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">       rv</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2019 - Written - Webb (UofT)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cluster</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">ntot</span><span class="p">),</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cluster</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

        <span class="n">ms</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span>
        <span class="n">partial_sum</span> <span class="o">=</span> <span class="n">weighted_inverse_distance_sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">partial_sum</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">ms</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">m</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">x</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span>
        <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
            <span class="n">zs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">ntot</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zs</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">z</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">ntot</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">xs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">ys</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">zs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
            <span class="n">dr2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dz</span> <span class="o">*</span> <span class="n">dz</span><span class="p">)</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dr2</span><span class="p">)</span>
            <span class="n">m_m</span> <span class="o">=</span> <span class="n">ms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">ms</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
            <span class="n">partial_sum</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m_m</span> <span class="o">/</span> <span class="n">dr</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">partial_sum</span><span class="p">)</span></div>


<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">weighted_inverse_distance_sum</span><span class="p">(</span><span class="n">cluster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       weighted_inverse_distance_sum</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Find the sum of the mass weighted inverse distance for each star</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster=[x,y,z,m].T</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">        weighted inverse distance sum</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2019 - Written - Webb (UofT)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weighted_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="p">)):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cluster</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">cluster</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="n">weighted_sum</span> <span class="o">+=</span> <span class="n">m2</span> <span class="o">/</span> <span class="n">r</span>

    <span class="k">return</span> <span class="n">weighted_sum</span>


<div class="viewcode-block" id="virial_radius_critical_density"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.virial_radius_critical_density">[docs]</a><span class="k">def</span> <span class="nf">virial_radius_critical_density</span><span class="p">(</span>
    <span class="n">cluster</span><span class="p">,</span>
    <span class="n">H</span><span class="o">=</span><span class="mf">70.0</span><span class="p">,</span>
    <span class="n">Om</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">overdens</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span>
    <span class="n">nrad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       rvirial</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Calculate virial radius of the cluster as the radius at which the density is equal to the critical </span>
<span class="sd">           density of the Universe at the redshift of the system, multiplied by an overdensity constant</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster - StarCluster instance</span>

<span class="sd">       H - Hubble constant</span>

<span class="sd">       Om - density of matter</span>

<span class="sd">       overdens - overdensity constant</span>

<span class="sd">       nrad - number of radial bins used to calculate cluster density profile</span>

<span class="sd">       projected - calculate projected virial radius (default: False)</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">       rv</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2019 - Written - Webb (UofT)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">units0</span><span class="p">,</span> <span class="n">origin0</span> <span class="o">=</span> <span class="n">save_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">to_pckms</span><span class="p">()</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">to_centre</span><span class="p">()</span>

    <span class="n">H</span> <span class="o">/=</span> <span class="mf">1000000.0</span>  <span class="c1"># (km/s) / pc</span>
    <span class="n">Grav</span> <span class="o">=</span> <span class="mf">4.302e-3</span>  <span class="c1"># pc (km/s)^2 / Msun</span>

    <span class="n">rhocrit</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">H</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">8.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Grav</span><span class="p">)</span>  <span class="c1"># Msun/pc^3</span>

    <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">-</span> <span class="n">cluster</span><span class="o">.</span><span class="n">rproorder</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">rorder</span>

    <span class="n">msum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">indx</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
        <span class="n">vsum</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">rpro</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">**</span> <span class="mf">3.0</span><span class="p">)</span>
        <span class="n">pprof</span> <span class="o">=</span> <span class="n">msum</span> <span class="o">/</span> <span class="n">vsum</span>
        <span class="n">rprof</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">rpro</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vsum</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">**</span> <span class="mf">3.0</span><span class="p">)</span>
        <span class="n">pprof</span> <span class="o">=</span> <span class="n">msum</span> <span class="o">/</span> <span class="n">vsum</span>
        <span class="n">rprof</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>

    <span class="c1"># Find radius where maxium density occurs</span>
    <span class="n">rindx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pprof</span><span class="p">)</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="n">rprof</span><span class="p">[</span><span class="n">rindx</span><span class="p">]</span>

    <span class="n">indx1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rprof</span> <span class="o">&gt;</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pprof</span> <span class="o">&gt;</span> <span class="n">rhocrit</span> <span class="o">*</span> <span class="n">overdens</span><span class="p">)</span>
    <span class="n">indx2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rprof</span> <span class="o">&gt;</span> <span class="n">rmax</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pprof</span> <span class="o">&lt;</span> <span class="n">rhocrit</span> <span class="o">*</span> <span class="n">overdens</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx2</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SYSTEM IS NOT VIRIALIZED&quot;</span><span class="p">)</span>
        <span class="n">r_v</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">rprof</span><span class="p">[</span><span class="n">indx1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">rprof</span><span class="p">[</span><span class="n">indx2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">rho1</span> <span class="o">=</span> <span class="n">pprof</span><span class="p">[</span><span class="n">indx1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rho2</span> <span class="o">=</span> <span class="n">pprof</span><span class="p">[</span><span class="n">indx2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">rho1</span><span class="p">,</span> <span class="n">rho2</span><span class="p">,</span> <span class="n">rhocrit</span> <span class="o">*</span> <span class="n">overdens</span><span class="p">)</span>
        <span class="n">r_v</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">([</span><span class="n">r1</span><span class="p">,</span> <span class="n">rho1</span><span class="p">],</span> <span class="p">[</span><span class="n">r2</span><span class="p">,</span> <span class="n">rho2</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">rhocrit</span> <span class="o">*</span> <span class="n">overdens</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">rho_local</span> <span class="o">=</span> <span class="n">rhocrit</span> <span class="o">*</span> <span class="n">overdens</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">overplot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;overplot&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">xunits</span> <span class="o">=</span> <span class="s2">&quot; (pc)&quot;</span>
        <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
            <span class="n">yunits</span> <span class="o">=</span> <span class="s2">&quot; Msun/pc^2&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yunits</span> <span class="o">=</span> <span class="s2">&quot; Msun/pc^3&quot;</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">rprof</span><span class="p">,</span> <span class="n">pprof</span>
        <span class="n">nlplot</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$R&quot;</span> <span class="o">+</span> <span class="n">xunits</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$rho&quot;</span> <span class="o">+</span> <span class="n">yunits</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Time = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cluster</span><span class="o">.</span><span class="n">tphys</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">overplot</span><span class="o">=</span><span class="n">overplot</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">nlplot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="n">rho_local</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">overplot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nlplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">*</span> <span class="n">r_v</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">overplot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">return_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">units0</span><span class="p">,</span> <span class="n">origin0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r_v</span></div>


<div class="viewcode-block" id="mass_function"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.mass_function">[docs]</a><span class="k">def</span> <span class="nf">mass_function</span><span class="p">(</span>
    <span class="n">cluster</span><span class="p">,</span>
    <span class="n">mmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nmass</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">emin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">emax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">kwmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">kwmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">indx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">mcorr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">omask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       mass_function</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Find mass function over a given mass range using nmass bins containing an equal number of stars</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster - StarCluster instance</span>
<span class="sd">       mmin/mmax - specific mass range</span>
<span class="sd">       nmass - number of mass bins used to calculate alpha</span>
<span class="sd">       rmin/rmax - specific radial range</span>
<span class="sd">       vmin/vmax - specific velocity range</span>
<span class="sd">       emin/emax - specific energy range</span>
<span class="sd">       kwmin/kwmax - specific stellar evolution type range</span>
<span class="sd">       indx - specific subset of stars</span>
<span class="sd">       projected - use projected values</span>
<span class="sd">       mcorr - correction for masses</span>
<span class="sd">       omask - place a mask over the dataset to mimic observed data</span>
<span class="sd">       plot - plot the mass function</span>
<span class="sd">       **kwargs - key words for plotting</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">       if omask is None: m_mean,m_hist,dm,alpha,ealpha,yalpha,eyalpha</span>
<span class="sd">       if omask is not None: m_mean,m_hist,dm,alpha,ealpha,yalpha,eyalpha, mbinerror</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2018 - Written - Webb (UofT)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">mcorr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">omask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mcorr</span> <span class="o">=</span> <span class="n">omask</span><span class="o">.</span><span class="n">mcorr</span>
                <span class="n">return_error</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">mcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">ntot</span><span class="p">)</span>
                <span class="n">return_error</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">ntot</span><span class="p">)</span>
            <span class="n">return_error</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">return_error</span><span class="o">=</span><span class="kc">True</span>

    <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">rpro</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">vpro</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">r</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">v</span>

    <span class="k">if</span> <span class="n">rmin</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mmin</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">indx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># Build subcluster containing only stars in the full radial and mass range:</span>
    <span class="n">indx</span> <span class="o">*=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="n">rmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">rmax</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">mmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">mmax</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;=</span> <span class="n">vmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;=</span> <span class="n">vmax</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">kw</span> <span class="o">&gt;=</span> <span class="n">kwmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">kw</span> <span class="o">&lt;=</span> <span class="n">kwmax</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">emin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">*=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">etot</span> <span class="o">&gt;=</span> <span class="n">emin</span>
    <span class="k">if</span> <span class="n">emin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">*=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">etot</span> <span class="o">&lt;=</span> <span class="n">emax</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmass</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">omask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">m_lower</span><span class="p">,</span> <span class="n">m_mean</span><span class="p">,</span> <span class="n">m_upper</span><span class="p">,</span> <span class="n">m_hist</span> <span class="o">=</span> <span class="n">nbinmaker</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">nmass</span><span class="p">)</span>
            <span class="n">m_corr_hist</span><span class="o">=</span><span class="n">m_hist</span>
            <span class="n">mbinerror</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nmass</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">m_lower</span><span class="p">,</span> <span class="n">m_mean</span><span class="p">,</span> <span class="n">m_upper</span> <span class="o">=</span> <span class="n">omask</span><span class="o">.</span><span class="n">m_lower</span><span class="p">,</span> <span class="n">omask</span><span class="o">.</span><span class="n">m_mean</span><span class="p">,</span> <span class="n">omask</span><span class="o">.</span><span class="n">m_upper</span>
                <span class="n">nmass</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_mean</span><span class="p">)</span>
                <span class="n">m_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmass</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">m_lower</span><span class="p">,</span> <span class="n">m_mean</span><span class="p">,</span> <span class="n">m_upper</span><span class="p">,</span> <span class="n">m_hist</span> <span class="o">=</span> <span class="n">nbinmaker</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">nmass</span><span class="p">)</span>

            <span class="n">m_corr_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m_hist</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_hist</span><span class="p">)):</span>
                <span class="n">mindx</span> <span class="o">=</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">m_lower</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">m_upper</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">indx</span>
                <span class="n">m_hist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mindx</span><span class="p">)</span>
                <span class="n">m_corr_hist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">mcorr</span><span class="p">[</span><span class="n">mindx</span><span class="p">])</span>

            <span class="n">mbinerror</span> <span class="o">=</span> <span class="n">m_hist</span> <span class="o">/</span> <span class="n">m_corr_hist</span>

        <span class="n">lm_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">m_mean</span><span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">m_corr_hist</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_upper</span> <span class="o">-</span> <span class="n">m_lower</span><span class="p">)</span>
        <span class="n">ldm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span>

        <span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">yalpha</span><span class="p">),</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">lm_mean</span><span class="p">,</span> <span class="n">ldm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ealpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">eyalpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">nplot</span><span class="p">(</span><span class="n">m_mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dm</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;LOG(dN/dM)&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">mfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">m_mean</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">m_mean</span><span class="p">),</span> <span class="n">nmass</span><span class="p">)</span>
            <span class="n">dmfit</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mfit</span><span class="p">)</span> <span class="o">+</span> <span class="n">yalpha</span><span class="p">)</span>
            <span class="n">nlplot</span><span class="p">(</span>
                <span class="n">mfit</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dmfit</span><span class="p">),</span> <span class="n">overplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\alpha$ = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">m_mean</span><span class="p">,</span> <span class="n">m_hist</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">ealpha</span><span class="p">,</span> <span class="n">yalpha</span><span class="p">,</span> <span class="n">eyalpha</span><span class="p">,</span> <span class="n">mbinerror</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">m_mean</span><span class="p">,</span> <span class="n">m_hist</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">ealpha</span><span class="p">,</span> <span class="n">yalpha</span><span class="p">,</span> <span class="n">eyalpha</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOT ENOUGH STARS TO ESTIMATE MASS FUNCTION&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmass</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmass</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmass</span><span class="p">),</span>
            <span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="eta_function"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.eta_function">[docs]</a><span class="k">def</span> <span class="nf">eta_function</span><span class="p">(</span>
    <span class="n">cluster</span><span class="p">,</span>
    <span class="n">mmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nmass</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">emin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">emax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">kwmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">kwmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">indx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">       eta_function</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">       Find eta over a given mass range using nmass bins containing an equal number of stars</span>

<span class="sd">    INPUT:</span>

<span class="sd">       cluster - StarCluster instance</span>

<span class="sd">       mmin/mmax - specific mass range</span>

<span class="sd">       nmass - number of mass bins used to calculate eta</span>

<span class="sd">       rmin/rmax - specific radial range</span>

<span class="sd">       vmin/vmax - specific velocity range</span>

<span class="sd">       emin/emax - specific energy range</span>

<span class="sd">       kwmin/kwmax - specific stellar evolution type range</span>

<span class="sd">       indx - specific subset of stars</span>

<span class="sd">       projected - use projected values</span>

<span class="sd">       plot - plot the mass function</span>
<span class="sd">       </span>
<span class="sd">       **kwargs - key words for plotting</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">       m_mean,sigvm,eta,eeta,yeta,eyeta</span>

<span class="sd">    HISTORY:</span>

<span class="sd">       2018 - Written - Webb (UofT)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">rpro</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">vpro</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">r</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">v</span>

    <span class="k">if</span> <span class="n">rmin</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mmin</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">indx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># Build subcluster containing only stars in the full radial and mass range:</span>
    <span class="n">indx</span> <span class="o">*=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="n">rmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">rmax</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">mmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="n">mmax</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;=</span> <span class="n">vmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;=</span> <span class="n">vmax</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">kw</span> <span class="o">&gt;=</span> <span class="n">kwmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">kw</span> <span class="o">&lt;=</span> <span class="n">kwmax</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">emin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">*=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">etot</span> <span class="o">&gt;=</span> <span class="n">emin</span>
    <span class="k">if</span> <span class="n">emin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">*=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">etot</span> <span class="o">&lt;=</span> <span class="n">emax</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nmass</span><span class="p">:</span>

        <span class="n">m_lower</span><span class="p">,</span> <span class="n">m_mean</span><span class="p">,</span> <span class="n">m_upper</span><span class="p">,</span> <span class="n">m_hist</span> <span class="o">=</span> <span class="n">nbinmaker</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span> <span class="n">nmass</span><span class="p">)</span>
        <span class="n">lm_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">m_mean</span><span class="p">)</span>

        <span class="n">sigvm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lsigvm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nmass</span><span class="p">):</span>

            <span class="n">mindx</span> <span class="o">=</span> <span class="n">indx</span> <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">m_lower</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">m_upper</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">sigvm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">mindx</span><span class="p">]))</span>
            <span class="n">lsigvm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigvm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">yeta</span><span class="p">),</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">lm_mean</span><span class="p">,</span> <span class="n">lsigvm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">eeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">eyeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">nplot</span><span class="p">(</span><span class="n">m_mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigvm</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\sigma_v$&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">mfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">m_mean</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">m_mean</span><span class="p">),</span> <span class="n">nmass</span><span class="p">)</span>
            <span class="n">sigfit</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="n">eta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mfit</span><span class="p">)</span> <span class="o">+</span> <span class="n">yeta</span><span class="p">)</span>
            <span class="n">nlplot</span><span class="p">(</span><span class="n">mfit</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sigfit</span><span class="p">),</span> <span class="n">overplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\eta$ = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eta</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">m_mean</span><span class="p">,</span> <span class="n">sigvm</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">eeta</span><span class="p">,</span> <span class="n">yeta</span><span class="p">,</span> <span class="n">eyeta</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOT ENOUGH STARS TO ESTIMATE SIGMA-MASS RELATION&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmass</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmass</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmass</span><span class="p">),</span>
            <span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="surface_area"><a class="viewcode-back" href="../../../reference/clustertools.analysis.functions.html#clustertools.analysis.functions.surface_area">[docs]</a><span class="k">def</span> <span class="nf">surface_area</span><span class="p">(</span>
    <span class="n">cluster</span><span class="p">,</span>
    <span class="n">mmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">emin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">emax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">kwmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">kwmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">indx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">projected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">coords</span><span class="o">=</span><span class="s2">&quot;xy&quot;</span><span class="p">,</span>
    <span class="n">thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nrand</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sphere&quot;</span><span class="p">,</span>
    <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NAME:</span>

<span class="sd">     surface_area</span>

<span class="sd">    PURPOSE:</span>

<span class="sd">     calculate surface area enclosed by cluster by finding what fraction of a random distribution overlaps with points</span>

<span class="sd">    INPUT:</span>

<span class="sd">     cluster - StarCluster instance</span>
<span class="sd">     </span>
<span class="sd">     mmin/mmax - specific mass range</span>
<span class="sd">     rmin/rmax - specific radial range</span>
<span class="sd">     vmin/vmax - specific velocity range</span>
<span class="sd">     emin/emax - specific energy range</span>
<span class="sd">     kwmin/kwmax - specific stellar evolution type range</span>
<span class="sd">     indx - specific subset of stars</span>
<span class="sd">     projected - use projected values</span>
<span class="sd">     </span>
<span class="sd">     coords - choose axis to project cluster (Default: xy)</span>
<span class="sd">     </span>
<span class="sd">     thresh - threshold for overlap between random distribution and points (Default: None - use maximum nearest neighbour)</span>

<span class="sd">     nrand - number of random points to be generated in uniform distribution (Default: 1000)</span>

<span class="sd">     method - generate spherical or rectangular distribution of random points (Default: sphere)</span>
<span class="sd">     </span>
<span class="sd">     plot - plot overlap (Default: False)</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">     area</span>

<span class="sd">    HISTORY:</span>

<span class="sd">     2019 - Written - Webb (UofT)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">projected</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">rpro</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">vpro</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">r</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">v</span>

    <span class="k">if</span> <span class="n">rmin</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mmin</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mmax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">indx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># Build subcluster containing only stars in the full radial and mass range:</span>
    <span class="n">indx</span> <span class="o">*=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="n">rmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">rmax</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">mmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="n">mmax</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;=</span> <span class="n">vmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;=</span> <span class="n">vmax</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">kw</span> <span class="o">&gt;=</span> <span class="n">kwmin</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">kw</span> <span class="o">&lt;=</span> <span class="n">kwmax</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">emin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">*=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">etot</span> <span class="o">&gt;=</span> <span class="n">emin</span>
    <span class="k">if</span> <span class="n">emin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">*=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">etot</span> <span class="o">&lt;=</span> <span class="n">emax</span>

    <span class="k">if</span> <span class="n">coords</span> <span class="o">==</span> <span class="s2">&quot;xy&quot;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span>
    <span class="k">elif</span> <span class="n">coords</span> <span class="o">==</span> <span class="s2">&quot;xz&quot;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">z</span>
    <span class="k">elif</span> <span class="n">coords</span> <span class="o">==</span> <span class="s2">&quot;yz&quot;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">y</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">z</span>

    <span class="k">return</span> <span class="n">area_enclosed</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="n">thresh</span><span class="p">,</span> <span class="n">nrand</span><span class="o">=</span><span class="n">nrand</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span>
    <span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">clustertools 0.1.dev1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Jeremy J. Webb.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.
    </div>
  </body>
</html>